name: Update Free Resources

on:
  # æ¯2å¤©åŒ—äº¬æ—¶é—´ä¸Šåˆ9ç‚¹è‡ªåŠ¨è¿è¡Œ (UTC 1:00)
  schedule:
    - cron: '0 1 */2 * *'

  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      enable_history:
        description: 'å¯ç”¨å†å²è®°å½•'
        required: false
        type: boolean
        default: true
      enable_dedup:
        description: 'å¯ç”¨å»é‡åŠŸèƒ½'
        required: false
        type: boolean
        default: true
      days_ago:
        description: 'æŸ¥è¯¢å¤©æ•°'
        required: false
        type: number
        default: 90

  # æ¨é€åˆ°main/masteråˆ†æ”¯æ—¶è§¦å‘ï¼ˆå¯é€‰ï¼‰
  push:
    branches:
      - main
      - master
    paths:
      - 'scripts/**'
      - '.github/workflows/**'
      - 'config.sh'

  # Pull Requestæ—¶è§¦å‘ï¼ˆå¯é€‰ï¼‰
  pull_request:
    branches:
      - main
      - master
    paths:
      - 'scripts/**'
      - '.github/workflows/**'

jobs:
  update:
    name: Update Resources
    runs-on: ubuntu-latest

    # è®¾ç½®è¶…æ—¶æ—¶é—´ï¼ˆé¿å…æ— é™ç­‰å¾…ï¼‰
    timeout-minutes: 15

    # å®‰å…¨çš„ç¯å¢ƒå˜é‡
    env:
      LOG_LEVEL: INFO
      ENABLE_NOTIFICATIONS: false
      ENABLE_FILE_LOG: true
      DAYS_AGO: 90
      MAX_RESOURCES: 15
      # æ–°åŠŸèƒ½é…ç½®
      ENABLE_HISTORY: ${{ inputs.enable_history || 'true' }}
      ENABLE_DEDUP: ${{ inputs.enable_dedup || 'true' }}
      HISTORY_RETENTION_DAYS: 90
      # æ€§èƒ½ä¼˜åŒ–
      ENABLE_LINK_VALIDATION: false

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq curl git

      - name: Verify dependencies
        run: |
          echo "Checking dependencies..."
          bash --version | head -n 1
          jq --version
          curl --version | head -n 1
          git --version

      - name: Make scripts executable
        run: |
          chmod +x scripts/*.sh
          chmod +x scripts/lib/*.sh
          chmod +x update.sh

      - name: Create necessary directories
        run: |
          mkdir -p data logs tmp docs
          touch logs/.gitkeep

      - name: Run update pipeline
        run: |
          bash update.sh

      - name: Check output
        run: |
          if [ -f "docs/free-for-dev-æœ€æ–°èµ„æº.md" ]; then
            echo "âœ“ Output file exists"
            wc -l docs/free-for-dev-æœ€æ–°èµ„æº.md
          else
            echo "âœ— Output file not found"
            exit 1
          fi

      - name: Get current date
        id: date
        run: |
          echo "date=$(date '+%Y-%m-%d')" >> $GITHUB_OUTPUT
          echo "time=$(date '+%H:%M:%S')" >> $GITHUB_OUTPUT

      - name: Generate workflow summary
        run: |
          cat >> $GITHUB_STEP_SUMMARY << EOF
          ## ğŸ“Š æ›´æ–°ç»Ÿè®¡

          ### åŸºæœ¬ä¿¡æ¯
          - **æ‰§è¡Œæ—¶é—´**: ${{ steps.date.outputs.date }} ${{ steps.date.outputs.time }}
          - **æäº¤SHA**: ${{ github.sha }}
          - **è¿è¡Œç¯å¢ƒ**: Ubuntu Latest
          - **è°ƒåº¦å‘¨æœŸ**: æ¯2å¤© UTC 1:00 (åŒ—äº¬æ—¶é—´9:00)

          ### åŠŸèƒ½çŠ¶æ€
          - **å†å²è®°å½•**: ${{ inputs.enable_history || 'true' }}
          - **å»é‡åŠŸèƒ½**: ${{ inputs.enable_dedup || 'true' }}
          - **æŸ¥è¯¢å¤©æ•°**: ${{ inputs.days_ago || '90' }}

          ### æ–‡ä»¶å˜æ›´
          EOF

          if [ -f "docs/free-for-dev-æœ€æ–°èµ„æº.md" ]; then
            echo "- **è¾“å‡ºæ–‡ä»¶**: \`docs/free-for-dev-æœ€æ–°èµ„æº.md\`" >> $GITHUB_STEP_SUMMARY
            echo "- **æ–‡ä»¶å¤§å°**: $(wc -c < docs/free-for-dev-æœ€æ–°èµ„æº.md | awk '{print $1}') å­—èŠ‚" >> $GITHUB_STEP_SUMMARY
            echo "- **è¡Œæ•°**: $(wc -l < docs/free-for-dev-æœ€æ–°èµ„æº.md | awk '{print $1}') è¡Œ" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ inputs.enable_history || 'true' }}" = "true" ] && [ -f "docs/history/index.md" ]; then
            echo "- **å†å²ç´¢å¼•**: \`docs/history/index.md\`" >> $GITHUB_STEP_SUMMARY
            echo "- **å†å²æ–‡æ¡£**: $(find docs/history -name "*.md" -type f | grep -v index.md | wc -l) ä¸ª" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ inputs.enable_dedup || 'true' }}" = "true" ] && [ -f "data/processed-commits.json" ]; then
            echo "- **å»é‡è®°å½•**: \`data/processed-commits.json\`" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### èµ„æºé¢„è§ˆ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          head -n 50 docs/free-for-dev-æœ€æ–°èµ„æº.md >> $GITHUB_STEP_SUMMARY || true
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

      - name: Commit changes
        if: success()
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          # æ·»åŠ æ‰€æœ‰å˜æ›´
          git add -A

          # æ£€æŸ¥æ˜¯å¦æœ‰å˜æ›´éœ€è¦æäº¤
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            # è·å–å½“å‰æ—¥æœŸï¼ˆå®‰å…¨çš„æ–¹å¼ï¼‰
            COMMIT_DATE=$(date '+%Y-%m-%d')
            # æäº¤å˜æ›´ï¼ˆä½¿ç”¨å˜é‡è€Œä¸æ˜¯ç›´æ¥æ’å€¼ï¼‰
            git commit -m "docs: è‡ªåŠ¨æ›´æ–°èµ„æºåˆ—è¡¨ ${COMMIT_DATE}"
            # æ¨é€åˆ°è¿œç¨‹ä»“åº“
            git push
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: workflow-logs-${{ github.run_number }}
          path: logs/
          retention-days: 7

      - name: Upload output
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: free-resources-${{ github.run_number }}
          path: docs/free-for-dev-æœ€æ–°èµ„æº.md
          retention-days: 90

      - name: Upload history index
        if: success() && inputs.enable_history == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: history-index-${{ github.run_number }}
          path: docs/history/index.md
          retention-days: 90

      - name: Notify on failure
        if: failure()
        run: |
          echo "::error::Resource update failed. Please check the logs."
          echo "::group::Error logs"
          tail -n 100 logs/*.log || echo "No logs found"
          echo "::endgroup::"
